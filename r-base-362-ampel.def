Bootstrap: docker
From: r-base:latest

%files
    files/root/.cabal/config /root/.cabal/config
    files/usr/local/bin/instpkg.R /usr/local/bin/instpkg.R

%post
    BUILDDEPS="libcurl4-openssl-dev \
        libssl-dev \
        libxml2-dev \
        libzmq3-dev \
        cabal-install"

    apt-get update -qq
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        $BUILDDEPS \
        libxml2 \
        libzmq5

    ## run R
    /usr/local/bin/instpkg.R \
        Cairo \
        DiagrammeR \
        Hmisc \
        bookdown \
        callr \
        clustermq \
        corrplot \
        cowplot \
        devtools \
        dplyr \
        drake \
        ggplot2 \
        glmnet \
        knitr \
        lubridate \
        mlr \
        mmpf \
        pROC \
        randomForestSRC \
        ranger \
        rappdirs \
        readr \
        readxl \
        rlang \
        rmarkdown \
        roxygen2 \
        rprojroot \
        skimr \
        survAUC \
        survival \
        survivalROC \
        survminer \
        tab \
        testthat \
        tidyr

    Rscript -e 'remove.packages("BiocManager")'

    cabal new-update
    ## workaround to get cabal new-install working
    ## https://github.com/haskell/cabal/issues/5516
    mkdir -p /root/.cabal/store/ghc-8.6.5/package.db
    cabal new-install \
        pandoc \
        pandoc-citeproc \
        pandoc-citeproc-preamble \
        pandoc-crossref \
        latex-formulae-pandoc

    ## workaround to get the pandoc binaries into useable directories
    ## `cabal install` --prefix/--global etc. seems not to work
    ## (even not in the config file, I know the want to provide nix-style
    ## package-manager)
    mv --force /root/.cabal/store/ghc-8.6.5/pandoc-*/bin/* /usr/bin/

    ## cleanup
    apt-get purge -y $BUILDDEPS
    apt-get autoremove --purge -y
    apt-get autoclean -y
    rm -rf /root/.cabal
    rm -rf /usr/share/doc/*
    rm -rf /usr/local/bin/inst*
    rm -rf /var/lib/apt/lists/*

%environment
    export LC_ALL=en_US.UTF-8
    export LANG=en_US.UTF-8
    export TZ=UTC

%runscript
    LANG=en R --vanilla --no-save

%labels
    Author Sebastian Gibb <mail@sebastiangibb.de>
    Version v0.0.1

%help
    This is a container with R and all necessary packages preinstalled to
    perform machine learning for the AMPEL project.
