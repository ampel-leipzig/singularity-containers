Bootstrap: docker
From: r-base:latest

%post
    BUILDDEPS="libcurl4-openssl-dev \
        libssl-dev \
        libxml2-dev \
        libzmq3-dev \
        cabal-install"

    apt-get update -qq
    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
        $BUILDDEPS \
        libxml2 \
        libzmq5

    # run R
    Rscript -e 'install.packages("BiocManager")'

    Rscript -e 'BiocManager::install(
        c(
            "drake",
            "mlr",
            "clustermq",
            "survival",
            "dplyr",
            "ggplot2",
            "lubridate",
            "readr",
            "readxl",
            "rlang",
            "rmarkdown",
            "rprojroot",
            "devtools",
            "callr",
            "cowplot",
            "testthat",
            "roxygen2",
            "knitr",
            "bookdown",
            "skimr",
            "DiagrammeR",
            "tab",
            "tidyr",
            "survminer",
            "corrplot",
            "survivalROC",
            "mmpf",
            "pROC"
        ),
        ask = FALSE,
        clean = TRUE,
        Ncpus = 3,
        INSTALL_opts = c("--strip", "--no-docs", "--no-multiarch")
    )'

    Rscript -e 'remove.packages("BiocManager")'

    cabal new-update
    ## workaround to get cabal new-install working
    ## https://github.com/haskell/cabal/issues/5516
    mkdir -p /root/.cabal/store/ghc-8.6.5/package.db
    cabal new-install --dependencies-only \
        pandoc \
        pandoc-citeproc \
        pandoc-citeproc-preamble \
        pandoc-crossref \
        latex-formulae-pandoc &&\
    cabal new-install --global \
        pandoc \
        pandoc-citeproc \
        pandoc-citeproc-preamble \
        pandoc-crossref \
        latex-formulae-pandoc

    ## cleanup
    apt-get purge -y $BUILDDEPS
    apt-get autoremove --purge -y
    apt-get autoclean -y
    rm -rf /var/lib/apt/lists/*
    rm -rf /root/.cabal/{logs,packages,store}

%environment
    export LC_ALL=en_US.UTF-8
    export LANG=en_US.UTF-8
    export TZ=UTC

%runscript
    LANG=en R --vanilla --no-save

%labels
    Author Sebastian Gibb <mail@sebastiangibb.de>
    Version v0.0.1

%help
    This is a container with R and all necessary packages preinstalled to
    perform machine learning for the AMPEL project.
